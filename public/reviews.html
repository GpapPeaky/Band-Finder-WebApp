<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Band Reviews</title>
  <link rel="stylesheet" href="./CSS/style.css" />
  <link rel="stylesheet" href="./CSS/navigation.css">
  <link rel="stylesheet" href="./CSS/reviewCards.css">
  <link rel="stylesheet" href="./CSS/publicEventCards.css">
  <link rel="stylesheet" href="./CSS/osm.css">
  <link rel="stylesheet" href="./CSS/availability.css">

  <!-- OSM -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


  <style>
    textarea {
        resize: none;
    }
  </style>
</head>

<body class = "reviewBody">
  <div class="reviewsContainer">
    <script src = "./JS/user.js"></script>
    <h1 id="title1"></h1>
    <ul id="reviews_list" class="review-list"></ul>

    <!-- Logged IN USER ONLY -->
    <div id="leave_review_section" style="display: none;">
    <h1>Leave a Review</h1>
    
    <form id="review_form">
        <label> 
        Rating:
        <select id="review_rating" required>
            <option value="">Select</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
        </select>
        </label>
    
        <br><br>
    
        <textarea
        id="review_text"
        placeholder="Write your review..."
        rows="5"
        required
        ></textarea>
    
        <br><br>
    
        <button type="submit" onclick="">Submit Review</button>
    </form>
    </div>
    
    <h1 id="title2"></h1>
    <ul id="public_events_list" class="publicEvent-list"></ul>

    <!-- Shiii -->
    <h1 id = "at" class="availTitle"></h1>
    <ul id="availabilities" class="availability-list"></ul>
    <span id = "AvailErr"></span>

    <footer id="mapFooter">
    <h3>Event Locations</h3>
    <div id="eventsMap"></div>
    </footer>

    <script>
    // OSM init
    let map;
    let markersLayer;
    
    function initMap() {
        map = L.map("eventsMap").setView([0, 0], 2);
        
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);
        
        markersLayer = L.layerGroup().addTo(map);
    }

    initMap();

    const params = new URLSearchParams(window.location.search);
    const bandName = params.get("band");
    const frag = window.location.hash;
    const bandID = frag ? frag.substring(1) : "";

    document.getElementById("title1").textContent =
        bandName ? `${bandName} Reviews` : "Band Reviews";
    
    if (isLoggedIn() && bandName) {
        document.getElementById("leave_review_section").style.display = "block";
    }

    async function fetchBandReviews() {
        const res = await fetch(
        `/general/reviews/${encodeURIComponent(bandName)}`
        );
        const data = await res.json();
    
        const list = document.getElementById("reviews_list");
        list.innerHTML = "";
    
        if (!data.reviews || data.reviews.length === 0) {
            list.innerHTML = "<p>No reviews yet.</p>";
            return;
        }
    
        data.reviews.forEach(r => {
        const li = document.createElement("li");

        // Show ONLY published reviews
        if (r.status == "published") {
            li.innerHTML = `
            <h3>${r.sender}</h3>
            <p><strong>Rating:</strong> ${r.rating}/5</p>
            <p>${r.review || ""}</p>
            `;
            li.classList.add("review"+ r.rating +"-card");
        }
    
        list.appendChild(li);
        });
    }
    
    if (bandName) {
        fetchBandReviews();
    }

    document.getElementById("title2").textContent =
        bandName ? `${bandName} Public Events` : "Band Public Events";
    
    async function fetchBandPublicEvents() {
        const res = await fetch(
        `/general/seePublicEvents`
        );
        const data = await res.json();
    
        const list = document.getElementById("public_events_list");
        list.innerHTML = "";
    
        if (!data.events || data.events.length === 0) {
            list.innerHTML = "<p>No public events.</p>";
            return;
        }

        const id = bandID;
        const bounds = []; // Map bounds
    
        data.events.forEach(r => {
            const li = document.createElement("li");

            const date = new Date(decodeURIComponent(r.event_datetime));

            const prettyDate = date.toLocaleString(undefined, {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            });

            // Show ONLY published events
            if (r.band_id == id) {
                li.innerHTML = `
                <h3><i>${r.event_type}</i></h3>
                <p><strong>${r.event_city}</strong></p>
                <p class="desc"> ${r.event_address}</p>
                <p class="desc">${prettyDate}</p>
                <p class="desc">${r.event_description || ""}</p>
                <p class="desc">Price: ${r.participants_price || ""}</p>
                `;
                li.classList.add("publicEvent-card");
            }
        
            list.appendChild(li);

            // --- MAP MARKER ---
            if (r.band_id == id && r.event_lat && r.event_lon) {
                const marker = L.marker([r.event_lat, r.event_lon])
                .bindPopup(`
                    <strong>${r.event_type}</strong><br>
                    ${r.event_city}<br>
                    ${r.event_datetime}
                `);
        
                markersLayer.addLayer(marker);
                bounds.push([r.event_lat, r.event_lon]);
            }
        });

        // Auto-zoom to markers
        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [30, 30] });
        }
    }

    async function fetchBandAvailability() {
        const user = JSON.parse(localStorage.getItem("currentUser"));
        const username = user.username;
        const password = user.password;

        document.getElementById("at").textContent =
            bandName ? `${bandName} Public Events` : "Band Public Events";

        const res = await fetch("/user/seeAvailability", {
            method: "POST",
            headers: {
            "Content-Type": "application/json",
            },
            body: JSON.stringify({
                username: username,
                password: password,
                band_name: bandName,
            }),
        });
        
        const data = await res.json();
        
        // Availability list
        const list = document.getElementById("availabilities");
        const listErr = document.getElementById("AvailErr");
        listErr.innerHTML = "";
        list.innerHTML = "";

        dates = data.dates;

        if (dates) {
            dates.forEach(r => {
                const li = document.createElement("li");
        
                const date = new Date(decodeURIComponent(r.event_datetime));

                const prettyDate = date.toLocaleString(undefined, {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });


                li.innerHTML = `${prettyDate}`;
                li.classList.add("availability-card");
            
                list.appendChild(li);
            });
        } else {
            const li = document.createElement("div");
        
            li.innerHTML = `Band is unavailable`;
            li.classList.add("NotAvailable");
            
            listErr.appendChild(li);
        }
    }

    
    if (bandName) {
        fetchBandPublicEvents();
        fetchBandAvailability();
    }

    const reviewForm = document.getElementById("review_form");

    reviewForm.addEventListener("submit", (e) => {
        e.preventDefault(); // stop page reload
        sendReview(bandName);
    });
    </script>
  </div>
</body>
</html>